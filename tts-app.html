<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Gemini TTS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              'brand-primary': '#4f46e5',
              'brand-secondary': '#7c3aed',
              'base-100': '#0f172a',
              'base-200': '#1e293b',
              'base-300': '#334155',
              'text-primary': '#f8fafc',
              'text-secondary': '#94a3b8',
            },
          },
        },
      }
    </script>
    <script type="importmap">
{
  "imports": {
    "@google/genai": "https://aistudiocdn.com/@google/genai@^1.29.0",
    "react-dom/": "https://aistudiocdn.com/react-dom@^19.2.0/",
    "react": "https://aistudiocdn.com/react@^19.2.0",
    "react/": "https://aistudiocdn.com/react@^19.2.0/"
  }
}
</script>
</head>
<body class="bg-base-100">
    <div id="root" class="min-h-screen bg-base-100 text-text-primary flex flex-col items-center justify-center p-4">

      <!-- API Key Section -->
      <div id="apiKeySection" class="w-full max-w-md mx-auto bg-base-200 p-8 rounded-2xl shadow-2xl">
        <h2 class="text-2xl font-bold text-center mb-4 text-text-primary">Enter API Key</h2>
        <p class="text-text-secondary text-center mb-6">Please provide your Google Gemini API key to continue.</p>
        <div class="space-y-4">
            <input 
                type="password" 
                id="apiKeyInput"
                placeholder="Your Gemini API Key"
                class="w-full p-3 bg-base-300 border border-base-300 rounded-lg text-text-primary placeholder-text-secondary focus:outline-none focus:ring-2 focus:ring-brand-primary transition-all duration-200"
            />
            <button id="saveApiKeyButton" class="flex items-center justify-center w-full px-6 py-3 border border-transparent text-base font-medium rounded-md text-white bg-brand-primary hover:bg-brand-secondary focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-base-100 focus:ring-brand-secondary transition-colors duration-200 ease-in-out">
                Save and Continue
            </button>
        </div>
      </div>

      <!-- Main App Section -->
      <div id="appSection" class="w-full max-w-2xl mx-auto" style="display: none;">
        <header class="text-center mb-8">
            <div class="flex justify-center items-center gap-4 mb-4">
                <svg class="w-12 h-12 text-brand-primary" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M2 10v4"></path><path d="M6 7v10"></path><path d="M10 4v16"></path><path d="M14 7v10"></path><path d="M18 10v4"></path><path d="M22 10v4"></path>
                </svg>
                <h1 class="text-4xl md:text-5xl font-bold tracking-tight bg-gradient-to-r from-brand-primary to-brand-secondary text-transparent bg-clip-text">
                    Gemini TTS
                </h1>
            </div>
          <p class="text-lg text-text-secondary">
            Transform your text into lifelike speech with the power of Gemini.
          </p>
        </header>

        <main class="bg-base-200 p-6 md:p-8 rounded-2xl shadow-2xl">
          <div class="space-y-6">
            <textarea
              id="textInput"
              placeholder="Enter text here..."
              class="w-full h-40 p-4 bg-base-300 border border-base-300 rounded-lg text-text-primary placeholder-text-secondary resize-none focus:outline-none focus:ring-2 focus:ring-brand-primary transition-all duration-200"
            >Hello! I am a friendly AI, ready to bring your words to life.</textarea>
            
            <div>
              <label for="voiceSelect" class="block text-sm font-medium text-text-secondary mb-2">Choose a Voice</label>
              <div class="relative">
                <select id="voiceSelect" class="appearance-none block w-full px-4 py-3 bg-base-200 border border-base-300 rounded-md text-text-primary placeholder-text-secondary focus:outline-none focus:ring-2 focus:ring-brand-primary focus:border-brand-primary transition-all duration-200 ease-in-out"></select>
                <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-text-secondary">
                  <svg class="fill-current h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" /></svg>
                </div>
              </div>
            </div>
            
            <div id="warningMessage" class="hidden bg-yellow-900/50 text-yellow-300 p-3 rounded-lg text-sm"></div>
          
            <div id="audioPlayerContainer"></div>
            
            <div id="errorMessage" class="hidden bg-red-900/50 text-red-300 p-3 rounded-lg text-sm"></div>

            <button id="generateButton" class="flex items-center justify-center w-full px-6 py-3 border border-transparent text-base font-medium rounded-md text-white bg-brand-primary hover:bg-brand-secondary focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-base-100 focus:ring-brand-secondary transition-colors duration-200 ease-in-out disabled:bg-base-300 disabled:cursor-not-allowed">
              <span class="flex items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                  <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd" />
                </svg>
                Generate & Play
              </span>
            </button>
          </div>
          
          <div id="historyContainer"></div>
        </main>
        
        <footer class="text-center mt-8 text-sm text-text-secondary">
          <p>Powered by Google Gemini. Built with Vanilla JS & Tailwind CSS.</p>
          <button id="changeApiKeyButton" class="text-brand-primary hover:underline mt-2">Change API Key</button>
        </footer>
      </div>
    </div>

    <script type="module">
        import { GoogleGenAI, Modality } from "@google/genai";

        // --- Start of Constants ---
        const AVAILABLE_VOICES = [
            { value: 'Kore', label: 'Kore (Female)' },
            { value: 'Puck', label: 'Puck (Male)' },
            { value: 'Charon', label: 'Charon (Male)' },
            { value: 'Fenrir', label: 'Fenrir (Male)' },
            { value: 'Zephyr', label: 'Zephyr (Female)' },
        ];
        const AUDIO_SAMPLE_RATE = 24000;
        const AUDIO_CHANNELS = 1;
        const MAX_TEXT_LENGTH = 1000;
        // --- End of Constants ---

        // --- Start of Audio Utilities ---
        function decode(base64) {
            const binaryString = atob(base64);
            const len = binaryString.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }
            return bytes;
        }

        function encode(bytes) {
            let binary = '';
            const len = bytes.byteLength;
            for (let i = 0; i < len; i++) {
                binary += String.fromCharCode(bytes[i]);
            }
            return btoa(binary);
        }

        function createWavBlob(pcmData, sampleRate, numChannels) {
            const dataInt16 = new Int16Array(pcmData.buffer);
            const dataSize = dataInt16.length * 2;
            const buffer = new ArrayBuffer(44 + dataSize);
            const view = new DataView(buffer);

            function writeString(view, offset, string) {
                for (let i = 0; i < string.length; i++) {
                    view.setUint8(offset + i, string.charCodeAt(i));
                }
            }

            writeString(view, 0, 'RIFF');
            view.setUint32(4, 36 + dataSize, true);
            writeString(view, 8, 'WAVE');
            writeString(view, 12, 'fmt ');
            view.setUint32(16, 16, true);
            view.setUint16(20, 1, true);
            view.setUint16(22, numChannels, true);
            view.setUint32(24, sampleRate, true);
            view.setUint32(28, sampleRate * numChannels * 2, true);
            view.setUint16(32, numChannels * 2, true);
            view.setUint16(34, 16, true);
            writeString(view, 36, 'data');
            view.setUint32(40, dataSize, true);

            for (let i = 0; i < dataInt16.length; i++) {
                view.setInt16(44 + i * 2, dataInt16[i], true);
            }

            return new Blob([view], { type: 'audio/wav' });
        }
        // --- End of Audio Utilities ---

        // --- Start of Text Utilities ---
        function splitText(text, maxLength) {
            if (text.length <= maxLength) return [text];
            
            const chunks = [];
            let currentPos = 0;
            
            while (currentPos < text.length) {
                let endPos = Math.min(currentPos + maxLength, text.length);
                
                if (endPos < text.length) {
                    const chunk = text.substring(currentPos, endPos);
                    let splitPos = -1;

                    for (const sep of ['.', '!', '?']) {
                        splitPos = Math.max(splitPos, chunk.lastIndexOf(sep));
                    }
                    
                    if (splitPos === -1) {
                        splitPos = chunk.lastIndexOf(' ');
                    }
                    
                    if (splitPos !== -1) {
                        endPos = currentPos + splitPos + 1;
                    }
                }
                
                chunks.push(text.substring(currentPos, endPos).trim());
                currentPos = endPos;
            }
            
            return chunks.filter(Boolean);
        }
        // --- End of Text Utilities ---

        document.addEventListener('DOMContentLoaded', () => {
            // --- State ---
            let history = [];
            let currentAudioUrl = '';
            let apiKey = '';

            // --- DOM Elements ---
            const apiKeySection = document.getElementById('apiKeySection');
            const appSection = document.getElementById('appSection');
            const apiKeyInput = document.getElementById('apiKeyInput');
            const saveApiKeyButton = document.getElementById('saveApiKeyButton');
            const changeApiKeyButton = document.getElementById('changeApiKeyButton');
            const textInput = document.getElementById('textInput');
            const voiceSelect = document.getElementById('voiceSelect');
            const generateButton = document.getElementById('generateButton');
            const warningMessage = document.getElementById('warningMessage');
            const errorMessage = document.getElementById('errorMessage');
            const audioPlayerContainer = document.getElementById('audioPlayerContainer');
            const historyContainer = document.getElementById('historyContainer');
            
            // --- UI Update Functions ---
            const setLoading = (isLoading) => {
                generateButton.disabled = isLoading;
                textInput.disabled = isLoading;
                voiceSelect.disabled = isLoading;
                if (isLoading) {
                    generateButton.innerHTML = `
                        <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        Generating...`;
                } else {
                    generateButton.innerHTML = `
                        <span class="flex items-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd" />
                            </svg>
                            Generate & Play
                        </span>`;
                }
            };
            
            const setError = (message) => {
                if (message) {
                    errorMessage.innerHTML = `<strong>Error:</strong> ${message}`;
                    errorMessage.classList.remove('hidden');
                } else {
                    errorMessage.classList.add('hidden');
                }
            };

            const setWarning = (message) => {
                if (message) {
                    warningMessage.innerHTML = `<strong>Notice:</strong> ${message}`;
                    warningMessage.classList.remove('hidden');
                } else {
                    warningMessage.classList.add('hidden');
                }
            };
            
            const renderAudioPlayer = (audioUrl, currentText) => {
                if (!audioUrl) {
                    audioPlayerContainer.innerHTML = '';
                    return;
                }
                audioPlayerContainer.innerHTML = `
                    <div class="space-y-4 my-6">
                      <div>
                        <p class="text-sm text-text-secondary mb-2">Now Playing:</p>
                        <p class="text-text-primary bg-base-300 p-3 rounded-md max-h-24 overflow-y-auto">${currentText}</p>
                      </div>
                       <div class="flex items-center gap-4">
                        <audio controls autoPlay src="${audioUrl}" class="w-full" style="color-scheme: dark;"></audio>
                        <a href="${audioUrl}" download="gemini-tts-audio.wav" aria-label="Download audio" class="flex-shrink-0 p-3 rounded-md bg-base-300 hover:bg-brand-primary text-text-secondary hover:text-white focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-base-200 focus:ring-brand-primary transition-colors">
                          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" />
                          </svg>
                        </a>
                      </div>
                    </div>`;
            };
            
            const renderHistory = () => {
                if(history.length === 0) {
                    historyContainer.innerHTML = '';
                    return;
                }
                const voiceMap = new Map(AVAILABLE_VOICES.map(v => [v.value, v.label]));
                historyContainer.innerHTML = `
                    <div class="mt-8 border-t border-base-300 pt-6">
                        <h2 class="text-xl font-semibold text-text-primary mb-4">History</h2>
                        <div class="space-y-3 max-h-60 overflow-y-auto pr-2">
                        ${history.map(item => `
                            <div class="flex items-center justify-between p-4 bg-base-300 rounded-lg">
                                <div class="flex-1 mr-4 overflow-hidden">
                                    <p class="text-text-primary truncate">${item.text}</p>
                                    <p class="text-xs text-text-secondary mt-1">${voiceMap.get(item.voice) || item.voice}</p>
                                </div>
                                <button data-id="${item.id}" aria-label="Play audio for: ${item.text}" class="history-play-button flex-shrink-0 p-2 rounded-full bg-brand-primary hover:bg-brand-secondary text-white focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-base-300 focus:ring-brand-secondary transition-colors">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor" style="pointer-events: none;">
                                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd" />
                                    </svg>
                                </button>
                            </div>
                        `).join('')}
                        </div>
                    </div>`;
            };

            // --- Core Logic ---
            const playAudio = (item) => {
                const audioData = decode(item.base64Audio);
                const wavBlob = createWavBlob(audioData, AUDIO_SAMPLE_RATE, AUDIO_CHANNELS);

                if (currentAudioUrl) {
                    URL.revokeObjectURL(currentAudioUrl);
                }
                
                currentAudioUrl = URL.createObjectURL(wavBlob);
                renderAudioPlayer(currentAudioUrl, item.text);
            };

            const handleGenerateSpeech = async () => {
                const text = textInput.value.trim();
                const selectedVoice = voiceSelect.value;
                if (!text) {
                  setError('Please enter some text to generate speech.');
                  return;
                }
                setLoading(true);
                setError(null);
                setWarning(null);

                if (text.length > MAX_TEXT_LENGTH) {
                    setWarning(`Text is long and will be split into parts. This may take a moment.`);
                }

                try {
                  const ai = new GoogleGenAI({ apiKey });
                  const chunks = splitText(text, MAX_TEXT_LENGTH);
                  
                  const base64AudioChunks = await Promise.all(
                    chunks.map(chunk => 
                        ai.models.generateContent({
                            model: "gemini-2.5-flash-preview-tts",
                            contents: [{ parts: [{ text: chunk }] }],
                            config: {
                                responseModalities: [Modality.AUDIO],
                                speechConfig: {
                                    voiceConfig: { prebuiltVoiceConfig: { voiceName: selectedVoice } },
                                },
                            },
                        }).then(response => {
                            const base64Audio = response.candidates?.[0]?.content?.parts?.[0]?.inlineData?.data;
                            if (!base64Audio) throw new Error("API response did not contain audio data.");
                            return base64Audio;
                        })
                    )
                  );
                  
                  const decodedChunks = base64AudioChunks.map(b64 => decode(b64));
                  const totalLength = decodedChunks.reduce((sum, chunk) => sum + chunk.length, 0);
                  const concatenatedPcm = new Uint8Array(totalLength);
                  
                  let offset = 0;
                  for (const chunk of decodedChunks) {
                    concatenatedPcm.set(chunk, offset);
                    offset += chunk.length;
                  }
                  
                  const base64Audio = encode(concatenatedPcm);

                  const newItem = {
                    id: crypto.randomUUID(),
                    text,
                    voice: selectedVoice,
                    base64Audio,
                  };

                  history.unshift(newItem);
                  renderHistory();
                  playAudio(newItem);

                } catch (err) {
                  setError(err.message || 'An unexpected error occurred.');
                  console.error(err);
                } finally {
                  setLoading(false);
                }
            };

            // --- API Key Management ---
            const checkApiKey = () => {
                apiKey = localStorage.getItem('gemini-api-key');
                if (apiKey) {
                    apiKeySection.style.display = 'none';
                    appSection.style.display = 'block';
                } else {
                    apiKeySection.style.display = 'block';
                    appSection.style.display = 'none';
                }
            };
            
            const handleSaveApiKey = () => {
                const key = apiKeyInput.value.trim();
                if (key) {
                    localStorage.setItem('gemini-api-key', key);
                    checkApiKey();
                }
            };

            const handleChangeApiKey = () => {
                localStorage.removeItem('gemini-api-key');
                apiKey = '';
                checkApiKey();
            };
            
            // --- Initialization and Event Listeners ---
            const init = () => {
                // Populate voices
                voiceSelect.innerHTML = AVAILABLE_VOICES.map(voice => `<option value="${voice.value}">${voice.label}</option>`).join('');
                
                // Set listeners
                saveApiKeyButton.addEventListener('click', handleSaveApiKey);
                changeApiKeyButton.addEventListener('click', handleChangeApiKey);
                generateButton.addEventListener('click', handleGenerateSpeech);
                historyContainer.addEventListener('click', (e) => {
                    if (e.target.classList.contains('history-play-button')) {
                        const id = e.target.dataset.id;
                        const item = history.find(h => h.id === id);
                        if (item) playAudio(item);
                    }
                });

                // Check for API key
                checkApiKey();
            };
            
            init();
        });
    </script>
</body>
</html>
